#
# Copyright 2025 agwlvssainokuni
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# AlertManager configuration for SqlApp2

global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@sqlapp2.example.com'
  smtp_auth_username: 'alerts@sqlapp2.example.com'
  smtp_auth_password: 'your_email_password'

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# The root route on which each incoming alert enters
route:
  group_by: ['alertname']
  group_wait: 5m
  group_interval: 10m
  repeat_interval: 12h
  receiver: 'web.hook'
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 30s
      repeat_interval: 5m
    
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 2m
      repeat_interval: 30m
    
    - match:
        severity: info
      receiver: 'info-alerts'
      group_wait: 5m
      repeat_interval: 6h

# Notification receivers
receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://127.0.0.1:5001/'
  
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@sqlapp2.example.com'
        subject: '[CRITICAL] SqlApp2 Alert: {{ .GroupLabels.alertname }}'
        body: |
          Alert Details:
          - Alert: {{ .GroupLabels.alertname }}
          - Severity: {{ .CommonLabels.severity }}
          - Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          - Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          - Time: {{ .CommonAnnotations.timestamp }}
          
          Please investigate immediately.
        html: |
          <h2>Critical Alert: {{ .GroupLabels.alertname }}</h2>
          <p><strong>Severity:</strong> {{ .CommonLabels.severity }}</p>
          <p><strong>Summary:</strong> {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><strong>Time:</strong> {{ .CommonAnnotations.timestamp }}</p>
          <p>Please investigate immediately.</p>
  
  - name: 'warning-alerts'
    email_configs:
      - to: 'monitoring@sqlapp2.example.com'
        subject: '[WARNING] SqlApp2 Alert: {{ .GroupLabels.alertname }}'
        body: |
          Alert Details:
          - Alert: {{ .GroupLabels.alertname }}
          - Severity: {{ .CommonLabels.severity }}
          - Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          - Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          - Time: {{ .CommonAnnotations.timestamp }}
          
          Please review when convenient.
  
  - name: 'info-alerts'
    email_configs:
      - to: 'logs@sqlapp2.example.com'
        subject: '[INFO] SqlApp2 Notification: {{ .GroupLabels.alertname }}'
        body: |
          Notification:
          - Event: {{ .GroupLabels.alertname }}
          - Summary: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          - Description: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          - Time: {{ .CommonAnnotations.timestamp }}

# Inhibit rules allow to mute a set of alerts given that another alert is firing
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'dev', 'instance']